<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة XO مع الأصدقاء</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            font-family: Arial, sans-serif;
        }
        .cell {
            width: 100px;
            height: 100px;
            font-size: 3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        #serverStatus {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <!-- شاشة إدخال الاسم -->
        <div id="nameScreen" class="text-center">
            <h1 class="mb-4">لعبة XO مع الأصدقاء</h1>
            <div class="card bg-dark bg-opacity-50 p-3 mb-3" style="max-width: 400px; margin: 0 auto;">
                <input type="text" id="playerName" class="form-control mb-3" placeholder="اسمك">
                <button id="saveName" class="btn btn-primary w-100">حفظ الاسم</button>
            </div>
        </div>

        <!-- شاشة الغرف -->
        <div id="roomScreen" class="text-center" style="display: none;">
            <div class="card bg-dark bg-opacity-50 p-3 mb-3" style="max-width: 400px; margin: 0 auto;">
                <button id="createRoom" class="btn btn-success mb-2 w-100">إنشاء غرفة جديدة</button>
                <div class="input-group">
                    <input type="text" id="roomCode" class="form-control" placeholder="كود الغرفة">
                    <button id="joinRoom" class="btn btn-primary">انضم</button>
                </div>
            </div>
        </div>

        <!-- شاشة اللعبة -->
        <div id="gameScreen" style="display: none;">
            <h2 id="roomStatus" class="mb-3"></h2>
            <div class="row mb-4">
                <div class="col-md-6 text-center">
                    <div class="p-2 rounded bg-success" id="player1Card">
                        <h5 id="player1Name"></h5>
                        <div>النقاط: <span id="player1Score">0</span></div>
                    </div>
                </div>
                <div class="col-md-6 text-center">
                    <div class="p-2 rounded" id="player2Card">
                        <h5 id="player2Name"></h5>
                        <div>النقاط: <span id="player2Score">0</span></div>
                    </div>
                </div>
            </div>

            <div class="board mx-auto" style="width: 300px;">
                <div class="row">
                    <div class="col-4 p-1"><div class="cell border rounded" data-index="0"></div></div>
                    <div class="col-4 p-1"><div class="cell border rounded" data-index="1"></div></div>
                    <div class="col-4 p-1"><div class="cell border rounded" data-index="2"></div></div>
                </div>
                <div class="row">
                    <div class="col-4 p-1"><div class="cell border rounded" data-index="3"></div></div>
                    <div class="col-4 p-1"><div class="cell border rounded" data-index="4"></div></div>
                    <div class="col-4 p-1"><div class="cell border rounded" data-index="5"></div></div>
                </div>
                <div class="row">
                    <div class="col-4 p-1"><div class="cell border rounded" data-index="6"></div></div>
                    <div class="col-4 p-1"><div class="cell border rounded" data-index="7"></div></div>
                    <div class="col-4 p-1"><div class="cell border rounded" data-index="8"></div></div>
                </div>
            </div>

            <div class="mt-4">
                <button id="resetGame" class="btn btn-warning me-2">إعادة اللعبة</button>
                <button id="leaveRoom" class="btn btn-danger">مغادرة الغرفة</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">إشعار</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>

    <div id="serverStatus">السيرفر غير نشط</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // ==================== SERVER CODE ====================
        function startServer() {
            const express = require('express');
            const app = express();
            const http = require('http').createServer(app);
            const io = require('socket.io')(http, {
                cors: {
                    origin: "*",
                    methods: ["GET", "POST"]
                }
            });

            const rooms = {};

            io.on('connection', (socket) => {
                console.log('مستخدم متصل:', socket.id);

                socket.on('createRoom', (data) => {
                    const roomId = generateRoomId();
                    rooms[roomId] = {
                        host: { id: data.playerId, name: data.playerName, socketId: socket.id },
                        guest: null,
                        board: Array(9).fill(''),
                        currentPlayer: 'X',
                        scores: { X: 0, O: 0 }
                    };
                    socket.join(roomId);
                    socket.emit('roomCreated', { roomId });
                    console.log(`تم إنشاء غرفة ${roomId} بواسطة ${data.playerName}`);
                });

                socket.on('joinRoom', (data) => {
                    if (rooms[data.roomId]) {
                        if (!rooms[data.roomId].guest) {
                            rooms[data.roomId].guest = { 
                                id: data.playerId, 
                                name: data.playerName,
                                socketId: socket.id
                            };
                            socket.join(data.roomId);
                            socket.emit('roomJoined', { 
                                success: true, 
                                roomId: data.roomId,
                                hostName: rooms[data.roomId].host.name,
                                symbol: 'O'
                            });
                            io.to(data.roomId).emit('playerJoined', {
                                playerId: data.playerId,
                                playerName: data.playerName
                            });
                            io.to(rooms[data.roomId].host.socketId).emit('gameStart', {
                                symbol: 'X'
                            });
                            console.log(`${data.playerName} انضم إلى غرفة ${data.roomId}`);
                        } else {
                            socket.emit('roomJoined', { 
                                success: false, 
                                message: 'الغرفة ممتلئة' 
                            });
                        }
                    } else {
                        socket.emit('roomJoined', { 
                            success: false, 
                            message: 'الغرفة غير موجودة' 
                        });
                    }
                });

                socket.on('makeMove', (data) => {
                    if (rooms[data.roomId]) {
                        const room = rooms[data.roomId];
                        if (room.board[data.index] === '' && room.currentPlayer === data.player) {
                            room.board[data.index] = data.player;
                            room.currentPlayer = data.player === 'X' ? 'O' : 'X';
                            io.to(data.roomId).emit('moveMade', {
                                index: data.index,
                                player: data.player
                            });
                            const winner = checkWinner(room.board);
                            if (winner || !room.board.includes('')) {
                                if (winner) {
                                    room.scores[winner]++;
                                }
                                io.to(data.roomId).emit('gameOver', {
                                    winner: winner,
                                    winnerName: winner === 'X' ? room.host.name : room.guest.name,
                                    scores: room.scores
                                });
                            }
                        }
                    }
                });

                socket.on('resetGame', (data) => {
                    if (rooms[data.roomId]) {
                        rooms[data.roomId].board = Array(9).fill('');
                        rooms[data.roomId].currentPlayer = 'X';
                        io.to(data.roomId).emit('gameReset');
                    }
                });

                socket.on('disconnect', () => {
                    // تنظيف الغرف عند مغادرة اللاعبين
                    for (const roomId in rooms) {
                        const room = rooms[roomId];
                        if (room.host.socketId === socket.id) {
                            if (room.guest) {
                                io.to(room.guest.socketId).emit('playerLeft');
                            }
                            delete rooms[roomId];
                            console.log(`تم حذف الغرفة ${roomId} بسبب مغادرة المضيف`);
                        } else if (room.guest && room.guest.socketId === socket.id) {
                            io.to(room.host.socketId).emit('playerLeft');
                            room.guest = null;
                            console.log(`غادر الضيف الغرفة ${roomId}`);
                        }
                    }
                });
            });

            function generateRoomId() {
                return Math.random().toString(36).substr(2, 6).toUpperCase();
            }

            function checkWinner(board) {
                const winPatterns = [
                    [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                    [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                    [0, 4, 8], [2, 4, 6]             // diagonals
                ];

                for (const pattern of winPatterns) {
                    const [a, b, c] = pattern;
                    if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                        return board[a];
                    }
                }
                return null;
            }

            http.listen(3000, () => {
                console.log('السيرفر يعمل على port 3000');
                document.getElementById('serverStatus').textContent = 'السيرفر نشط - http://localhost:3000';
                document.getElementById('serverStatus').style.backgroundColor = 'green';
            });
        }

        // ==================== CLIENT CODE ====================
        // العناصر
        const elements = {
            nameScreen: document.getElementById('nameScreen'),
            roomScreen: document.getElementById('roomScreen'),
            gameScreen: document.getElementById('gameScreen'),
            playerName: document.getElementById('playerName'),
            saveName: document.getElementById('saveName'),
            createRoom: document.getElementById('createRoom'),
            roomCode: document.getElementById('roomCode'),
            joinRoom: document.getElementById('joinRoom'),
            roomStatus: document.getElementById('roomStatus'),
            player1Name: document.getElementById('player1Name'),
            player2Name: document.getElementById('player2Name'),
            player1Score: document.getElementById('player1Score'),
            player2Score: document.getElementById('player2Score'),
            player1Card: document.getElementById('player1Card'),
            player2Card: document.getElementById('player2Card'),
            cells: document.querySelectorAll('.cell'),
            resetGame: document.getElementById('resetGame'),
            leaveRoom: document.getElementById('leaveRoom'),
            toast: new bootstrap.Toast(document.getElementById('toast'))
        };

        // حالة اللعبة
        const state = {
            socket: null,
            playerId: Math.random().toString(36).substr(2, 9),
            playerName: '',
            roomId: '',
            isHost: false,
            symbol: '',
            currentPlayer: 'X',
            board: ['', '', '', '', '', '', '', '', ''],
            scores: { X: 0, O: 0 },
            opponent: { id: '', name: '' }
        };

        // تهيئة السوكيت
        function initSocket() {
            state.socket = io('http://localhost:3000', { 
                transports: ['websocket'],
                withCredentials: true
            });
            
            state.socket.on('connect', () => {
                showToast('تم الاتصال', 'تم الاتصال بالسيرفر بنجاح');
            });

            state.socket.on('roomCreated', (data) => {
                state.roomId = data.roomId;
                state.isHost = true;
                updateGameUI();
                showToast('تم إنشاء الغرفة', `كود الغرفة: ${data.roomId}`);
            });

            state.socket.on('roomJoined', (data) => {
                if (data.success) {
                    state.roomId = data.roomId;
                    state.isHost = false;
                    state.symbol = data.symbol;
                    updateGameUI();
                    showToast('تم الانضمام', `انضممت إلى غرفة ${data.hostName}`);
                } else {
                    showToast('خطأ', data.message);
                }
            });

            state.socket.on('gameStart', (data) => {
                state.symbol = data.symbol;
            });

            state.socket.on('playerJoined', (data) => {
                state.opponent.id = data.playerId;
                state.opponent.name = data.playerName;
                updateGameUI();
                showToast('لاعب جديد', `انضم ${data.playerName} إلى الغرفة`);
            });

            state.socket.on('moveMade', (data) => {
                state.board[data.index] = data.player;
                updateCell(data.index, data.player);
                state.currentPlayer = data.player === 'X' ? 'O' : 'X';
                updateTurnUI();
            });

            state.socket.on('gameOver', (data) => {
                if (data.winner) {
                    state.scores = data.scores;
                    updateScores();
                    showToast('فوز', `${data.winnerName} فاز بالجولة!`);
                } else {
                    showToast('تعادل', 'انتهت الجولة بالتعادل');
                }
            });

            state.socket.on('gameReset', () => {
                resetBoard();
                showToast('إعادة', 'تم إعادة اللعبة');
            });

            state.socket.on('playerLeft', () => {
                showToast('مغادرة', 'غادر الخصم الغرفة');
                resetGameState();
            });
        }

        // وظائف المساعدة
        function showToast(title, message) {
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            elements.toast.show();
        }

        function updateGameUI() {
            elements.nameScreen.style.display = 'none';
            elements.roomScreen.style.display = 'none';
            elements.gameScreen.style.display = 'block';

            elements.roomStatus.textContent = `كود الغرفة: ${state.roomId}`;
            
            if (state.isHost) {
                elements.player1Name.textContent = state.playerName;
                elements.player2Name.textContent = state.opponent.name || 'في انتظار الخصم...';
            } else {
                elements.player1Name.textContent = state.opponent.name;
                elements.player2Name.textContent = state.playerName;
            }

            updateTurnUI();
            updateScores();
        }

        function updateTurnUI() {
            if (state.currentPlayer === 'X') {
                elements.player1Card.classList.add('bg-success');
                elements.player2Card.classList.remove('bg-success');
            } else {
                elements.player1Card.classList.remove('bg-success');
                elements.player2Card.classList.add('bg-success');
            }
        }

        function updateCell(index, player) {
            const cell = elements.cells[index];
            cell.textContent = player;
            cell.style.color = player === 'X' ? '#f9ca24' : '#7ed6df';
        }

        function resetBoard() {
            state.board = ['', '', '', '', '', '', '', '', ''];
            elements.cells.forEach(cell => {
                cell.textContent = '';
                cell.style.color = '';
            });
            state.currentPlayer = 'X';
            updateTurnUI();
        }

        function updateScores() {
            elements.player1Score.textContent = state.scores.X;
            elements.player2Score.textContent = state.scores.O;
        }

        function resetGameState() {
            resetBoard();
            state.scores = { X: 0, O: 0 };
            updateScores();
            state.opponent = { id: '', name: '' };
            elements.gameScreen.style.display = 'none';
            elements.roomScreen.style.display = 'block';
        }

        // مستمعي الأحداث
        elements.saveName.addEventListener('click', () => {
            const name = elements.playerName.value.trim();
            if (name) {
                state.playerName = name;
                localStorage.setItem('xoPlayerName', name);
                elements.nameScreen.style.display = 'none';
                elements.roomScreen.style.display = 'block';
                initSocket();
            } else {
                showToast('خطأ', 'الرجاء إدخال اسم');
            }
        });

        elements.createRoom.addEventListener('click', () => {
            if (state.socket) {
                state.socket.emit('createRoom', {
                    playerId: state.playerId,
                    playerName: state.playerName
                });
            } else {
                showToast('خطأ', 'لا يوجد اتصال بالسيرفر');
            }
        });

        elements.joinRoom.addEventListener('click', () => {
            const roomCode = elements.roomCode.value.trim();
            if (roomCode) {
                if (state.socket) {
                    state.socket.emit('joinRoom', {
                        roomId: roomCode,
                        playerId: state.playerId,
                        playerName: state.playerName
                    });
                } else {
                    showToast('خطأ', 'لا يوجد اتصال بالسيرفر');
                }
            } else {
                showToast('خطأ', 'الرجاء إدخال كود الغرفة');
            }
        });

        elements.cells.forEach(cell => {
            cell.addEventListener('click', () => {
                const index = cell.getAttribute('data-index');
                if (!state.board[index] && state.currentPlayer === state.symbol) {
                    state.socket.emit('makeMove', {
                        roomId: state.roomId,
                        index: index,
                        player: state.symbol
                    });
                }
            });
        });

        elements.resetGame.addEventListener('click', () => {
            if (state.socket) {
                state.socket.emit('resetGame', { roomId: state.roomId });
            }
        });

        elements.leaveRoom.addEventListener('click', () => {
            if (state.socket) {
                state.socket.emit('leaveRoom', { roomId: state.roomId });
                resetGameState();
            }
        });

        // تحميل اسم اللاعب عند البدء
        window.addEventListener('DOMContentLoaded', () => {
            const savedName = localStorage.getItem('xoPlayerName');
            if (savedName) {
                state.playerName = savedName;
                elements.playerName.value = savedName;
            }
            
            // بدء السيرفر عند تحميل الصفحة
            try {
                startServer();
            } catch (e) {
                console.log('لا يمكن بدء السيرفر من جانب العميل. يجب تشغيل السيرفر بشكل منفصل.');
                document.getElementById('serverStatus').textContent = 'يتصل بسيرفر خارجي';
            }
        });
    </script>
</body>
</html>
